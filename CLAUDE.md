# Claude Assistant Context

This document provides context for Claude when working on the Opera Generator project.

## Project Overview

This is an AI-powered opera generation system built with Java 21 and LangChain4j 1.1.0. The system creates complete operas by:
1. Using GPT-4.1 and Claude Sonnet 4 to alternately write scenes
2. Generating illustrations with OpenAI's gpt-image-1 model
3. Creating formatted libretti with embedded images

## Key Technical Details

### Java 21 Features Used
- **Virtual threads** for concurrent image generation
- **Records** for domain modeling (Opera and Scene)
- **Pattern matching** in switch expressions
- **Text blocks** for multi-line strings

### Important Model Information
- **gpt-image-1**: Returns base64-encoded images (not URLs), no revised prompt, no token usage info
- **Image generation timeout**: Set to 3 minutes due to slow response times
- **Rate limiting**: Max 2 concurrent image requests with 1-second delays to avoid API throttling

### Project Structure
```
src/main/java/com/kousenit/
├── IntegratedOperaGenerator.java  # Main entry point
├── Opera.java                     # Domain model (Opera and Scene records)
├── Conversation.java              # AI scene generation logic
├── LibrettoWriter.java           # File output handling
├── OperaImageGenerator.java      # Image generation with rate limiting
├── ImageSaver.java               # Handles base64 and URL image saving
├── AiModels.java                 # Model configurations
├── ApiKeys.java                  # Environment variable access
├── OperaOrganizer.java          # Utility for organizing completed operas
└── OperaCritic.java             # Generates critical reviews using Gemini
```

### Workflow

1. **IntegratedOperaGenerator** orchestrates the entire process
2. **Conversation** generates scenes alternating between AI models
3. **LibrettoWriter** saves markdown and individual scene files
4. **OperaImageGenerator** creates illustrations with rate limiting
5. **OperaOrganizer** can reorganize files and create complete libretti
6. **OperaCritic** (optional) generates critical review using Gemini

### Testing Commands

```bash
# Run main opera generation
./gradlew run

# Run specific tests
./gradlew test --tests ImageModelTest
./gradlew test --tests OperaGenerationIntegrationTest

# Compile and run main class directly
./gradlew compileJava
java -cp build/classes/java/main com.kousenit.IntegratedOperaGenerator
```

### Known Issues and Solutions

1. **gpt-image-1 timeouts**: Already handled with 3-minute timeout
2. **Rate limiting**: Implemented with Semaphore (max 2 concurrent) and delays
3. **Generic titles**: Improved prompt to request creative opera titles
4. **Incomplete operas**: ✅ SOLVED - Created continuation system with `ContinueHartfordOperaTest`
5. **Markdown stanza formatting**: ✅ SOLVED - Implemented Option 1 formatting with blockquotes and `<br>` tags

### Current State (COMPLETE PROJECT)

✅ **"Hartford Ascending: An Opera of Love and Ruins" - COMPLETE 8-Scene Opera**:
- **Scenes 1-5**: Original generation (complete)
- **Scenes 6-8**: Continuation successfully generated and merged
- **All 8 illustrations**: Generated and properly organized
- **Complete libretto**: Fully merged with proper stanza formatting
- **Critical review**: Generated by Gemini AI critic
- **Professional formatting**: Scenes 1-2 and final ensemble formatted with Option 1 style

**File Structure**:
```
src/main/resources/hartford_ascending_an_opera_of_love_and_ruins/
├── hartford_ascending_an_opera_of_love_and_ruins_complete_libretto.md (8 scenes)
├── hartford_ascending_an_opera_of_love_and_ruins_critique.md
├── scene_1_encounter_beneath_the_banyan_trees.txt + scene_1_illustration.png
├── scene_2_the_agent's_oath.txt + scene_2_illustration.png  
├── scene_3_heartbeats_and_warning_calls.txt + scene_3_illustration.png
├── scene_4_the_mechanical_pursuit.txt + scene_4_illustration.png
├── scene_5_among_echoes_and_ruins.txt + scene_5_illustration.png
├── scene_6_the_gates_of_awakening.txt + scene_6_illustration.png
├── scene_7_the_heart_of_hartford.txt + scene_7_illustration.png
└── scene_8_finale_–_the_new_dawn.txt + scene_8_illustration.png
```

### Opera Completion Workflow

**Created successful pattern for continuing unfinished operas**:
1. `ContinueHartfordOperaTest.java` - Template for opera continuation
2. Proper scene numbering (6, 7, 8) with context from previous scenes
3. Image generation for new scenes with rate limiting
4. Successful merger into main opera directory
5. Complete libretto integration

### Libretto Formatting System

**Implemented Option 1 formatting for beautiful stanza display**:
- **Before**: `CHARACTER (description): Line one, Line two, Line three.`
- **After**: `**CHARACTER** (voice type): > Line one,<br> > Line two,<br> > Line three.`
- **Status**: Scenes 1-2 and finale fully converted, guide created for remaining scenes
- **Documentation**: `LIBRETTO_FORMATTING_GUIDE.md` provides complete implementation roadmap

### Next Steps for New Work

When continuing development:
1. ✅ Opera is complete - can use as reference for new operas
2. ✅ Continuation pattern established - use `ContinueHartfordOperaTest` as template
3. ✅ Formatting system established - use `LIBRETTO_FORMATTING_GUIDE.md`
4. Consider: Generate new operas with different themes/settings
5. Consider: Apply Option 1 formatting to remaining scenes (3-7) using the guide

### Environment Requirements

Must have these environment variables set:
- `OPENAI_API_KEY`
- `ANTHROPIC_API_KEY`
- `GOOGLEAI_API_KEY` (only for critique functionality)

### Useful Patterns

```java
// Rate-limited image generation
OperaImageGenerator.generateImages(opera);

// Generate opera with custom parameters
Opera opera = conversation.generateOpera(title, numberOfScenes);

// Continue an opera (from ContinueHartfordOperaTest pattern)
String continuationContext = premise + """
    IMPORTANT CONTINUATION CONTEXT:
    The opera has already progressed through 5 scenes...
    Continue from Scene 6. You must complete the opera in 3 scenes...
    """;
Opera continuation = conversation.generateOpera(title, continuationContext, 3);

// Copy continuation files to main directory
cp src/main/resources/continuation/*.txt src/main/resources/main_opera/
mv src/main/resources/scene_*_illustration.png src/main/resources/main_opera/
```

### Continuation Test Pattern

When creating continuation tests, follow this proven pattern:
1. Read existing libretto to extract premise
2. Create continuation context with story summary
3. Generate new scenes with proper numbering (startingSceneNumber + i)
4. Save to separate continuation directory first
5. Generate images for new scenes
6. Copy/move files to main opera directory
7. Update complete libretto with new scenes

### Formatting Workflow

For applying Option 1 formatting to remaining scenes:
1. Find pattern: `CHARACTER (description):`
2. Replace with: `**CHARACTER** (voice_type, description):`
3. Add blockquote `>` to start of each lyric line
4. Add `<br>` to end of each lyric line (except last in stanza)
5. Keep stage directions `[...]` outside blockquotes